{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ExpressionContext",
  "type": "object",
  "properties": {
    "request": {
      "description": "`request` contains attributes about the incoming HTTP request",
      "type": ["object", "null"],
      "properties": {
        "method": {
          "description": "The HTTP method of the request.",
          "type": "string"
        },
        "uri": {
          "description": "The URI of the request.",
          "type": "string"
        },
        "path": {
          "description": "The path of the request URI.",
          "type": "string"
        },
        "headers": {
          "description": "The headers of the request.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "body": {
          "description": "The body of the request. Warning: accessing the body will cause the body to be buffered.",
          "type": ["array", "string", "null"],
          "items": {
            "type": "integer",
            "format": "uint8",
            "minimum": 0,
            "maximum": 255
          }
        }
      },
      "additionalProperties": false,
      "required": ["method", "uri", "path", "headers"]
    },
    "response": {
      "description": "`response` contains attributes about the HTTP response",
      "type": ["object", "null"],
      "properties": {
        "code": {
          "description": "The HTTP status code of the response.",
          "type": "integer",
          "format": "uint16",
          "minimum": 0,
          "maximum": 65535
        }
      },
      "additionalProperties": false,
      "required": ["code"]
    },
    "jwt": {
      "description": "`jwt` contains the claims from a verified JWT token. This is only present if the JWT policy is enabled.",
      "type": ["object", "null"],
      "additionalProperties": true
    },
    "llm": {
      "description": "`llm` contains attributes about an LLM request or response. This is only present when using an `ai` backend.",
      "type": ["object", "null"],
      "properties": {
        "streaming": {
          "description": "Whether the LLM response is streamed.",
          "type": "boolean"
        },
        "requestModel": {
          "description": "The model requested for the LLM request. This may differ from the actual model used.",
          "type": "string"
        },
        "responseModel": {
          "description": "The model that actually served the LLM response.",
          "type": ["string", "null"]
        },
        "provider": {
          "description": "The provider of the LLM.",
          "type": "string"
        },
        "inputTokens": {
          "description": "The number of tokens in the input/prompt.",
          "type": ["integer", "null"],
          "format": "uint64",
          "minimum": 0
        },
        "outputTokens": {
          "description": "The number of tokens in the output/completion.",
          "type": ["integer", "null"],
          "format": "uint64",
          "minimum": 0
        },
        "totalTokens": {
          "description": "The total number of tokens for the request.",
          "type": ["integer", "null"],
          "format": "uint64",
          "minimum": 0
        },
        "prompt": {
          "description": "The prompt sent to the LLM. Warning: accessing this has some performance impacts for large prompts.",
          "type": ["array", "null"],
          "items": {
            "type": "object",
            "properties": {
              "role": {
                "type": "string"
              },
              "content": {
                "type": "string"
              }
            },
            "additionalProperties": false,
            "required": ["role", "content"]
          }
        },
        "completion": {
          "description": "The completion from the LLM. Warning: accessing this has some performance impacts for large responses.",
          "type": ["array", "null"],
          "items": {
            "type": "string"
          }
        },
        "params": {
          "description": "The parameters for the LLM request.",
          "type": "object",
          "properties": {
            "temperature": {
              "type": ["number", "null"],
              "format": "double"
            },
            "top_p": {
              "type": ["number", "null"],
              "format": "double"
            },
            "frequency_penalty": {
              "type": ["number", "null"],
              "format": "double"
            },
            "presence_penalty": {
              "type": ["number", "null"],
              "format": "double"
            },
            "seed": {
              "type": ["integer", "null"],
              "format": "int64"
            },
            "max_tokens": {
              "type": ["integer", "null"],
              "format": "uint64",
              "minimum": 0
            }
          }
        }
      },
      "additionalProperties": false,
      "required": ["streaming", "requestModel", "provider", "params"]
    },
    "source": {
      "description": "`source` contains attributes about the source of the request.",
      "type": ["object", "null"],
      "properties": {
        "address": {
          "description": "The IP address of the downstream connection.",
          "type": "string",
          "format": "ip"
        },
        "port": {
          "description": "The port of the downstream connection.",
          "type": "integer",
          "format": "uint16",
          "minimum": 0,
          "maximum": 65535
        },
        "identity": {
          "description": "The (Istio SPIFFE) identity of the downstream connection, if available.",
          "type": ["object", "null"],
          "properties": {
            "trustDomain": {
              "description": "The trust domain of the identity.",
              "type": "string"
            },
            "namespace": {
              "description": "The namespace of the identity.",
              "type": "string"
            },
            "serviceAccount": {
              "description": "The service account of the identity.",
              "type": "string"
            }
          },
          "additionalProperties": false,
          "required": ["trustDomain", "namespace", "serviceAccount"]
        }
      },
      "additionalProperties": false,
      "required": ["address", "port"]
    },
    "mcp": {
      "description": "`mcp` contains attributes about the MCP request.",
      "anyOf": [
        {
          "oneOf": [
            {
              "description": "The tool being accessed",
              "type": "object",
              "properties": {
                "tool": {
                  "type": "object",
                  "properties": {
                    "target": {
                      "description": "The target of the resource",
                      "type": "string",
                      "default": ""
                    },
                    "name": {
                      "description": "The name of the resource",
                      "type": "string",
                      "default": ""
                    }
                  }
                }
              },
              "required": ["tool"],
              "additionalProperties": false
            },
            {
              "description": "The prompt being accessed",
              "type": "object",
              "properties": {
                "prompt": {
                  "type": "object",
                  "properties": {
                    "target": {
                      "description": "The target of the resource",
                      "type": "string",
                      "default": ""
                    },
                    "name": {
                      "description": "The name of the resource",
                      "type": "string",
                      "default": ""
                    }
                  }
                }
              },
              "required": ["prompt"],
              "additionalProperties": false
            },
            {
              "description": "The resource being accessed",
              "type": "object",
              "properties": {
                "resource": {
                  "type": "object",
                  "properties": {
                    "target": {
                      "description": "The target of the resource",
                      "type": "string",
                      "default": ""
                    },
                    "name": {
                      "description": "The name of the resource",
                      "type": "string",
                      "default": ""
                    }
                  }
                }
              },
              "required": ["resource"],
              "additionalProperties": false
            }
          ]
        },
        {
          "type": "null"
        }
      ]
    },
    "extauthz": {
      "description": "`extauthz` contains dynamic metadata from ext_authz filters",
      "type": ["object", "null"],
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}
